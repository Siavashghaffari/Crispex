# GitLab CI/CD Pipeline for Crispex
# Runs tests, builds packages, and validates distribution

stages:
  - test
  - build
  - validate

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "3.9"

# Cache pip packages for faster subsequent runs
cache:
  paths:
    - .cache/pip
    - .pytest_cache

# Test job - runs on multiple Python versions
.test_template: &test_template
  stage: test
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -e ".[dev]"
  script:
    - echo "Running tests on Python $PYTHON_VERSION"
    # Lint with flake8 - fail on critical errors only
    - flake8 src/crispex --count --select=E9,F63,F7,F82 --show-source --statistics || exit 1
    # Run tests with coverage
    - pytest tests/ -v --cov=crispex --cov-report=xml --cov-report=term-missing
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 week
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'

# Test on Python 3.9
test:python39:
  <<: *test_template
  image: python:3.9
  variables:
    PYTHON_VERSION: "3.9"

# Test on Python 3.10
test:python310:
  <<: *test_template
  image: python:3.10
  variables:
    PYTHON_VERSION: "3.10"

# Test on Python 3.11
test:python311:
  <<: *test_template
  image: python:3.11
  variables:
    PYTHON_VERSION: "3.11"

# Build distribution packages
build:package:
  stage: build
  image: python:3.9
  needs: ["test:python39", "test:python310", "test:python311"]
  before_script:
    - pip install --upgrade pip build twine
  script:
    - echo "Building distribution packages..."
    - python -m build
    - echo "Checking package with twine..."
    - twine check dist/*
    - echo "Build completed successfully"
    - ls -lh dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

# Validate package installation
validate:installation:
  stage: validate
  image: python:3.9
  needs: ["build:package"]
  before_script:
    - pip install --upgrade pip
  script:
    - echo "Testing installation from wheel..."
    - pip install dist/*.whl
    - echo "Testing CLI..."
    - crispex --version
    - crispex --help
    - echo "Testing Python import..."
    - python -c "from crispex import design_guides; print('Import successful!')"
    - echo "Validation completed successfully - package is installable and runnable!"
  only:
    - main
    - develop
    - tags

# Performance metrics tracking
performance:metrics:
  stage: validate
  image: python:3.9
  needs: ["test:python39"]
  script:
    - pip install --upgrade pip
    - pip install -e ".[dev]"
    - echo "Collecting performance metrics..."
    - echo "Test execution time captured in test job"
    - pytest tests/ --durations=10
  allow_failure: true
  only:
    - main
    - develop

# Code quality check
quality:flake8:
  stage: test
  image: python:3.9
  before_script:
    - pip install flake8
  script:
    - echo "Running full code quality check..."
    - flake8 src/crispex --count --max-complexity=15 --max-line-length=100 --statistics || true
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Code formatting check
quality:black:
  stage: test
  image: python:3.9
  before_script:
    - pip install black
  script:
    - echo "Checking code formatting..."
    - black --check src/crispex/ || true
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests
